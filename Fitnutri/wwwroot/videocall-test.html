<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitNutri - Teste de Videochamada</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@7.0.14/dist/browser/signalr.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .config-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .config-panel h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
            margin-right: 10px;
        }

        button:hover {
            background: #5568d3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        button.danger {
            background: #e74c3c;
        }

        button.danger:hover {
            background: #c0392b;
        }

        .video-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .video-wrapper {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .video-wrapper video {
            width: 100%;
            height: 400px;
            object-fit: cover;
        }

        .video-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin-bottom: 20px;
        }

        .status {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.connected {
            background: #2ecc71;
        }

        .status-indicator.disconnected {
            background: #e74c3c;
        }

        .log-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            overflow-y: auto;
        }

        .log-panel h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .log-entry {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 3px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }

        .log-entry.info {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .log-entry.error {
            background: #ffebee;
            color: #c62828;
        }

        .log-entry.warning {
            background: #fff3e0;
            color: #ef6c00;
        }

        @media (max-width: 768px) {
            .video-container {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>游꿘 FitNutri - Teste de Videochamada</h1>
            <p>Sistema de teste para videochamada WebRTC + SignalR</p>
        </div>

        <div class="config-panel">
            <h2>丘뙖잺 Configura칞칚o</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="apiUrl">URL da API:</label>
                    <input type="text" id="apiUrl" value="https://localhost:7001" placeholder="Ex: https://localhost:7001">
                </div>
                <div class="form-group">
                    <label for="apiKey">x-api-key:</label>
                    <input type="text" id="apiKey" placeholder="Cole a API Key aqui">
                </div>
            </div>
            <div class="form-group">
                <label for="token">Token JWT:</label>
                <input type="text" id="token" placeholder="Cole seu token JWT aqui">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="agendamentoId">ID do Agendamento:</label>
                    <input type="text" id="agendamentoId" placeholder="Ex: 123e4567-e89b-12d3-a456-426614174000">
                </div>
                <div class="form-group">
                    <label for="userId">User ID:</label>
                    <input type="text" id="userId" placeholder="Seu ID de usu치rio">
                </div>
            </div>
            <div class="form-group">
                <label for="userType">Tipo de Usu치rio:</label>
                <select id="userType">
                    <option value="profissional">Profissional</option>
                    <option value="paciente">Paciente</option>
                </select>
            </div>
            <button onclick="initializeCall()">Iniciar Videochamada</button>
            <button onclick="connectToHub()">Conectar ao SignalR</button>
        </div>

        <div class="status">
            <strong>Status:</strong>
            <span class="status-indicator disconnected" id="statusIndicator"></span>
            <span id="statusText">Desconectado</span>
            <span style="margin-left: 20px;">|</span>
            <span style="margin-left: 10px;" id="participantsCount">0 participantes</span>
        </div>

        <div class="video-container">
            <div class="video-wrapper">
                <video id="localVideo" autoplay muted playsinline></video>
                <div class="video-label">游닟 Voc칡 (Local)</div>
            </div>
            <div class="video-wrapper">
                <video id="remoteVideo" autoplay playsinline></video>
                <div class="video-label">游녻 Participante Remoto</div>
            </div>
        </div>

        <div class="controls">
            <button onclick="toggleAudio()">游꿗 Ativar/Desativar 츼udio</button>
            <button onclick="toggleVideo()">游닟 Ativar/Desativar V칤deo</button>
            <button class="danger" onclick="leaveCall()">游 Encerrar Chamada</button>
        </div>

        <div class="log-panel">
            <h3>游늶 Log de Eventos</h3>
            <div id="logContainer"></div>
        </div>
    </div>

    <script>
        let hubConnection = null;
        let localStream = null;
        let peerConnections = new Map();
        let audioEnabled = true;
        let videoEnabled = true;
        let callToken = null;

        const iceServers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.insertBefore(entry, logContainer.firstChild);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            if (connected) {
                indicator.className = 'status-indicator connected';
                text.textContent = 'Conectado';
            } else {
                indicator.className = 'status-indicator disconnected';
                text.textContent = 'Desconectado';
            }
        }

        async function initializeCall() {
            try {
                const apiUrl = document.getElementById('apiUrl').value;
                const apiKey = document.getElementById('apiKey').value;
                const token = document.getElementById('token').value;
                const agendamentoId = document.getElementById('agendamentoId').value;

                if (!apiKey || !token || !agendamentoId) {
                    log('x-api-key, Token JWT e ID do Agendamento s칚o obrigat칩rios', 'error');
                    alert('Preencha a API Key, Token JWT e o ID do Agendamento');
                    return;
                }

                log('Iniciando videochamada via API...');

                const response = await fetch(`${apiUrl}/api/videocall/initiate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ agendamentoId: agendamentoId })
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(`Erro ao iniciar chamada: ${error}`);
                }

                const data = await response.json();
                callToken = data.callToken;
                log(`Chamada iniciada! Token: ${callToken}`, 'info');
                log(`Hub URL: ${data.hubUrl}`, 'info');

                await connectToHub();
            } catch (error) {
                log(`Erro: ${error.message}`, 'error');
                alert(`Erro ao iniciar chamada: ${error.message}`);
            }
        }

        async function connectToHub() {
            try {
                const apiUrl = document.getElementById('apiUrl').value;
                const token = document.getElementById('token').value;
                const agendamentoId = document.getElementById('agendamentoId').value;
                const userId = document.getElementById('userId').value;
                const userType = document.getElementById('userType').value;

                if (!token || !agendamentoId || !userId) {
                    log('Token, ID do Agendamento e User ID s칚o obrigat칩rios', 'error');
                    alert('Preencha todos os campos obrigat칩rios');
                    return;
                }

                log('Conectando ao SignalR Hub (sem x-api-key - est치 no bypass)...');

                const hubUrl = `${apiUrl}/videocall`;
                hubConnection = new signalR.HubConnectionBuilder()
                    .withUrl(hubUrl, {
                        accessTokenFactory: () => token
                    })
                    .withAutomaticReconnect()
                    .build();

                setupHubHandlers();

                await hubConnection.start();
                log('Conectado ao SignalR Hub!', 'info');
                updateStatus(true);

                await getLocalStream();
                await hubConnection.invoke('JoinCall', agendamentoId, userId, userType);
                log(`Entrou na sala de chamada: ${agendamentoId}`, 'info');

            } catch (error) {
                log(`Erro ao conectar: ${error.message}`, 'error');
                updateStatus(false);
                alert(`Erro ao conectar: ${error.message}`);
            }
        }

        function setupHubHandlers() {
            hubConnection.on('UserJoined', async (userId, userType, connectionId) => {
                log(`Usu치rio entrou: ${userId} (${userType})`, 'info');
                await createPeerConnection(connectionId, true);
            });

            hubConnection.on('ExistingParticipants', async (participants) => {
                log(`${participants.length} participante(s) j치 na chamada`, 'info');
                for (const participant of participants) {
                    await createPeerConnection(participant.connectionId, true);
                }
                updateParticipantCount(participants.length + 1);
            });

            hubConnection.on('ReceiveOffer', async (offer, fromConnectionId) => {
                log(`Oferta recebida de ${fromConnectionId}`, 'info');
                await handleOffer(offer, fromConnectionId);
            });

            hubConnection.on('ReceiveAnswer', async (answer, fromConnectionId) => {
                log(`Resposta recebida de ${fromConnectionId}`, 'info');
                await handleAnswer(answer, fromConnectionId);
            });

            hubConnection.on('ReceiveIceCandidate', async (candidate) => {
                log('ICE candidate recebido', 'info');
                await handleIceCandidate(candidate);
            });

            hubConnection.on('UserLeft', (connectionId) => {
                log(`Usu치rio saiu: ${connectionId}`, 'warning');
                closePeerConnection(connectionId);
            });

            hubConnection.on('UserToggledAudio', (connectionId, enabled) => {
                log(`Usu치rio ${connectionId} ${enabled ? 'ativou' : 'desativou'} o 치udio`, 'info');
            });

            hubConnection.on('UserToggledVideo', (connectionId, enabled) => {
                log(`Usu치rio ${connectionId} ${enabled ? 'ativou' : 'desativou'} o v칤deo`, 'info');
            });

            hubConnection.onclose(() => {
                log('Desconectado do SignalR Hub', 'warning');
                updateStatus(false);
            });

            hubConnection.onreconnecting(() => {
                log('Reconectando...', 'warning');
                updateStatus(false);
            });

            hubConnection.onreconnected(() => {
                log('Reconectado!', 'info');
                updateStatus(true);
            });
        }

        async function getLocalStream() {
            try {
                log('Solicitando acesso  c칙mera e microfone...');
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = localStream;
                log('Stream local obtido com sucesso!', 'info');
            } catch (error) {
                log(`Erro ao acessar m칤dia: ${error.message}`, 'error');
                alert('Erro ao acessar c칙mera/microfone. Verifique as permiss칫es.');
            }
        }

        async function createPeerConnection(connectionId, isInitiator) {
            log(`Criando peer connection para ${connectionId} (Iniciador: ${isInitiator})`, 'info');

            const pc = new RTCPeerConnection(iceServers);
            peerConnections.set(connectionId, pc);

            // Adiciona tracks locais
            localStream.getTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });

            // Recebe tracks remotos
            pc.ontrack = (event) => {
                log(`Track remoto recebido de ${connectionId}`, 'info');
                const remoteVideo = document.getElementById('remoteVideo');
                if (remoteVideo.srcObject !== event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                    log('Stream remoto conectado ao v칤deo!', 'info');
                }
            };

            // ICE Candidate
            pc.onicecandidate = async (event) => {
                if (event.candidate) {
                    log('Enviando ICE candidate...', 'info');
                    const agendamentoId = document.getElementById('agendamentoId').value;
                    await hubConnection.invoke('SendIceCandidate', 
                        agendamentoId, 
                        JSON.stringify(event.candidate), 
                        connectionId
                    );
                }
            };

            pc.onconnectionstatechange = () => {
                log(`Connection state: ${pc.connectionState}`, 'info');
            };

            pc.oniceconnectionstatechange = () => {
                log(`ICE connection state: ${pc.iceConnectionState}`, 'info');
            };

            // Se for o iniciador, cria e envia a oferta
            if (isInitiator) {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                const agendamentoId = document.getElementById('agendamentoId').value;
                await hubConnection.invoke('SendOffer', 
                    agendamentoId, 
                    JSON.stringify(offer), 
                    connectionId
                );
                log('Oferta enviada!', 'info');
            }
        }

        async function handleOffer(offerJson, fromConnectionId) {
            const offer = JSON.parse(offerJson);
            let pc = peerConnections.get(fromConnectionId);

            if (!pc) {
                await createPeerConnection(fromConnectionId, false);
                pc = peerConnections.get(fromConnectionId);
            }

            await pc.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            const agendamentoId = document.getElementById('agendamentoId').value;
            await hubConnection.invoke('SendAnswer', 
                agendamentoId, 
                JSON.stringify(answer), 
                fromConnectionId
            );
            log('Resposta enviada!', 'info');
        }

        async function handleAnswer(answerJson, fromConnectionId) {
            const answer = JSON.parse(answerJson);
            const pc = peerConnections.get(fromConnectionId);

            if (pc) {
                await pc.setRemoteDescription(new RTCSessionDescription(answer));
                log('Remote description definido!', 'info');
            }
        }

        async function handleIceCandidate(candidateJson) {
            const candidate = JSON.parse(candidateJson);
            
            for (const [connectionId, pc] of peerConnections) {
                try {
                    await pc.addIceCandidate(new RTCIceCandidate(candidate));
                    log('ICE candidate adicionado', 'info');
                } catch (error) {
                    log(`Erro ao adicionar ICE candidate: ${error.message}`, 'error');
                }
            }
        }

        function closePeerConnection(connectionId) {
            const pc = peerConnections.get(connectionId);
            if (pc) {
                pc.close();
                peerConnections.delete(connectionId);
                log(`Peer connection fechado: ${connectionId}`, 'info');
            }
        }

        async function toggleAudio() {
            if (!localStream) return;

            audioEnabled = !audioEnabled;
            localStream.getAudioTracks().forEach(track => {
                track.enabled = audioEnabled;
            });

            if (hubConnection) {
                const agendamentoId = document.getElementById('agendamentoId').value;
                await hubConnection.invoke('ToggleAudio', agendamentoId, audioEnabled);
            }

            log(`츼udio ${audioEnabled ? 'ativado' : 'desativado'}`, 'info');
        }

        async function toggleVideo() {
            if (!localStream) return;

            videoEnabled = !videoEnabled;
            localStream.getVideoTracks().forEach(track => {
                track.enabled = videoEnabled;
            });

            if (hubConnection) {
                const agendamentoId = document.getElementById('agendamentoId').value;
                await hubConnection.invoke('ToggleVideo', agendamentoId, videoEnabled);
            }

            log(`V칤deo ${videoEnabled ? 'ativado' : 'desativado'}`, 'info');
        }

        async function leaveCall() {
            try {
                log('Encerrando chamada...');

                const agendamentoId = document.getElementById('agendamentoId').value;

                if (hubConnection) {
                    await hubConnection.invoke('LeaveCall', agendamentoId);
                    await hubConnection.stop();
                    hubConnection = null;
                }

                peerConnections.forEach((pc, connectionId) => {
                    closePeerConnection(connectionId);
                });

                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }

                document.getElementById('localVideo').srcObject = null;
                document.getElementById('remoteVideo').srcObject = null;

                updateStatus(false);
                updateParticipantCount(0);
                log('Chamada encerrada!', 'info');

            } catch (error) {
                log(`Erro ao encerrar chamada: ${error.message}`, 'error');
            }
        }

        function updateParticipantCount(count) {
            document.getElementById('participantsCount').textContent = `${count} participante(s)`;
        }

        window.onbeforeunload = () => {
            leaveCall();
        };

        log('P치gina carregada. Configure os par칙metros e clique em "Iniciar Videochamada"', 'info');
    </script>
</body>
</html>

