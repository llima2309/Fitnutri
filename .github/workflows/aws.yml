name: Deploy Fitnutri API to ECS

on:
  push:
    branches: [ "dev" ]
  workflow_dispatch:

permissions:
  contents: write  # Necess√°rio para criar tags Git
  packages: read

env:
  AWS_REGION: us-east-1
  # ARNs reais do seu ambiente:
  ECS_CLUSTER_ARN: arn:aws:ecs:us-east-1:763548578114:cluster/fitnutri-cluster
  ECS_SERVICE_ARN: arn:aws:ecs:us-east-1:763548578114:service/fitnutri-cluster/fitnutri-api-task-service-4kszczgw
  ECR_REPO: fitnutri-api
  # Build
  PLATFORM: linux/amd64
  DOCKERFILE: DockerfileApi
  BUILD_CONTEXT: .
  # Tags
  ALIAS_TAG: prod
  # Project path for version extraction
  PROJECT_PATH: Fitnutri/Fitnutri.csproj
  # Healthcheck ALB (opcional)
  WAIT_TG_HEALTH: "true"
  TIMEOUT: "300"
  SLEEP_SEC: "10"

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Extract Assembly Version
        id: version
        shell: bash
        run: |
          set -euo pipefail
          echo "==> Extracting version from $PROJECT_PATH"
          
          # Extrai a vers√£o do arquivo .csproj
          VERSION=$(grep -o '<Version>[^<]*</Version>' "$PROJECT_PATH" | sed 's/<Version>//g' | sed 's/<\/Version>//g')
          
          if [ -z "$VERSION" ]; then
            echo "‚ùå Vers√£o n√£o encontrada no arquivo $PROJECT_PATH"
            exit 1
          fi
          
          echo "PROJECT_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Vers√£o encontrada: $VERSION"
          
          # Cria tag com a vers√£o + timestamp para garantir unicidade
          TIMESTAMP=$(date +%Y%m%d-%H%M)
          VERSION_TAG="v${VERSION}-${TIMESTAMP}"
          echo "VERSION_TAG=$VERSION_TAG" >> $GITHUB_ENV
          echo "Tag de vers√£o: $VERSION_TAG"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Resolve account and ECR URI + compute tags
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          ACCOUNT_ID="$(aws sts get-caller-identity --query Account --output text)"
          echo "ACCOUNT_ID=$ACCOUNT_ID" >> $GITHUB_ENV
          ECR_URI="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}"
          echo "ECR_URI=$ECR_URI" >> $GITHUB_ENV
          
          # Tag imut√°vel usando vers√£o + commit
          IMAGE_TAG="${PROJECT_VERSION}-${GITHUB_SHA::7}"
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          
          echo "Deploying to: $ECR_URI"
          echo "Version tag: $VERSION_TAG"
          echo "Image tag: $IMAGE_TAG"
          echo "Project version: $PROJECT_VERSION"

      - name: Assert Task Definition uses alias tag (:prod)
        shell: bash
        run: |
          # Descobre a task definition atual do service
          TASK_DEF_NAME=$(aws ecs describe-services \
            --cluster "${ECS_CLUSTER_ARN}" \
            --services "${ECS_SERVICE_ARN}" \
            --query 'services[0].taskDefinition' --output text)

          echo "TaskDefinition: $TASK_DEF_NAME"

          IMG=$(aws ecs describe-task-definition \
            --task-definition "$TASK_DEF_NAME" \
            --query 'taskDefinition.containerDefinitions[0].image' \
            --output text)

          echo "Container image in TaskDef: $IMG"

          if [[ "$IMG" != *":${ALIAS_TAG}" ]]; then
            echo "‚ùå A Task Definition n√£o referencia a tag alias ':${ALIAS_TAG}'."
            echo "   Atualize a imagem da Task Definition para terminar com ':${ALIAS_TAG}'"
            echo "   Ex.: ${ECR_REPO}:${ALIAS_TAG} ou <account>.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${ALIAS_TAG}"
            exit 1
          fi

      - name: Build and Push (version + alias tags)
        shell: bash
        run: |
          set -euo pipefail
          echo "==> Build & Push com m√∫ltiplas tags"
          docker buildx build \
            --platform "${PLATFORM}" \
            -f "${DOCKERFILE}" \
            -t "${ECR_URI}:${IMAGE_TAG}" \
            -t "${ECR_URI}:${PROJECT_VERSION}" \
            -t "${ECR_URI}:${ALIAS_TAG}" \
            -t "${ECR_URI}:latest" \
            "${BUILD_CONTEXT}" \
            --push

      - name: Create Git Tag
        shell: bash
        run: |
          set -euo pipefail
          echo "==> Criando tag Git: $VERSION_TAG"
          
          # Configura git (necess√°rio para criar tags)
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Cria tag anotada com informa√ß√µes do deploy
          git tag -a "$VERSION_TAG" -m "Deploy v$PROJECT_VERSION - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          # Push da tag para o reposit√≥rio
          git push origin "$VERSION_TAG"

      - name: Force new deployment
        shell: bash
        run: |
          set -euo pipefail
          echo "==> For√ßando novo deployment no ECS"
          aws ecs update-service \
            --cluster "${ECS_CLUSTER_ARN}" \
            --service "${ECS_SERVICE_ARN}" \
            --force-new-deployment \
            --region "${AWS_REGION}" >/dev/null

      - name: Wait for ECS service stability
        shell: bash
        run: |
          echo "==> Aguardando ECS estabilizar..."
          aws ecs wait services-stable \
            --cluster "${ECS_CLUSTER_ARN}" \
            --services "${ECS_SERVICE_ARN}" \
            --region "${AWS_REGION}"

      - name: Done
        run: |
          echo "==> Deploy conclu√≠do com sucesso üéâ"
          echo "    Vers√£o do projeto: v${PROJECT_VERSION}"
          echo "    Tag Git criada: ${VERSION_TAG}"
          echo "    Tags Docker criadas:"
          echo "      - ${ECR_URI}:${IMAGE_TAG} (imut√°vel)"
          echo "      - ${ECR_URI}:${PROJECT_VERSION} (vers√£o)"
          echo "      - ${ECR_URI}:${ALIAS_TAG} (alias)"
          echo "      - ${ECR_URI}:latest"
