# ===== build =====
FROM mcr.microsoft.com/dotnet/sdk:10.0 AS build
WORKDIR /src

# Copia apenas os csproj (cache de restore)
COPY AppFitNutri.Core/AppFitNutri.Core.csproj AppFitNutri.Core/
COPY SiteFitNutri/SiteFitNutri.csproj       SiteFitNutri/

# Restore do site (puxa dependências e o ProjectReference)
RUN dotnet restore SiteFitNutri/SiteFitNutri.csproj

# Copia o restante do código necessário
COPY AppFitNutri.Core/ AppFitNutri.Core/
COPY SiteFitNutri/     SiteFitNutri/

# Publica o Site
RUN dotnet publish SiteFitNutri/SiteFitNutri.csproj -c Release -o /app /p:UseAppHost=false

# ===== runtime =====
FROM mcr.microsoft.com/dotnet/aspnet:10.0
WORKDIR /app

# Blazor Server atrás do ALB/ELB
ENV ASPNETCORE_URLS=http://0.0.0.0:8080
ENV ASPNETCORE_FORWARDEDHEADERS_ENABLED=true
ENV DOTNET_EnableDiagnostics=0

COPY --from=build /app ./
EXPOSE 8080
ENTRYPOINT ["dotnet", "SiteFitNutri.dll"]
