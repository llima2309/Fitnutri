<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="AppFitNutri.Views.HomeWorkoutPage"
             x:Name="HomeWorkoutRoot"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodel="clr-namespace:AppFitNutri.ViewModel"
             xmlns:model="clr-namespace:AppFitNutri.Models"
             xmlns:converters="clr-namespace:AppFitNutri.Converters"
             x:DataType="viewmodel:HomeWorkoutViewModel"
             Title="Treino em Casa">
    
    <ContentPage.Background>
        <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
            <GradientStop Color="#4A90E2" Offset="0.0" />
            <GradientStop Color="#7ED321" Offset="0.5" />
            <GradientStop Color="#4A90E2" Offset="1.0" />
        </LinearGradientBrush>
    </ContentPage.Background>

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:BoolInverseConverter x:Key="BoolInverse" />
            <converters:NullToBoolConverter x:Key="NullToBoolConverter" />
            <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
            <converters:StringToBoolConverter x:Key="StringToBoolConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ContentPage.BindingContext>
        <viewmodel:HomeWorkoutViewModel />
    </ContentPage.BindingContext>

    <Grid>
        <!-- Loading Indicator -->
        <ActivityIndicator IsRunning="{Binding IsLoading}"
                           IsVisible="{Binding IsLoading}"
                           Color="White"
                           VerticalOptions="Center"
                           HorizontalOptions="Center"
                           Scale="1.5" />

        <!-- Main Content -->
        <ScrollView Padding="24" IsVisible="{Binding IsLoading, Converter={StaticResource BoolInverse}}">
            <VerticalStackLayout Spacing="16">

                <!-- Weekly Plan Card (labels same as gym but textual) -->
                <Border BackgroundColor="#FFFFFFF2"
                        StrokeShape="RoundRectangle 24"
                        Padding="16"
                        Margin="0">
                    <Border.Shadow>
                        <Shadow Brush="#0000001F" Offset="0,4" Radius="8" />
                    </Border.Shadow>
                    
                    <VerticalStackLayout Spacing="12">
                        <Label Text="PLANO DE TREINO SEMANAL"
                               FontSize="18"
                               FontAttributes="Bold"
                               TextColor="#1E293B"
                               HorizontalTextAlignment="Center" />
                        
                        <Label Text="Treinos em casa"
                               FontSize="14"
                               TextColor="#64748B"
                               HorizontalTextAlignment="Center"
                               Margin="0,0,0,8" />

                        <!-- Week Grid badges -->
                        <Grid ColumnDefinitions="*,*,*,*,*,*,*" 
                              RowDefinitions="Auto,Auto"
                              ColumnSpacing="4"
                              RowSpacing="4"
                              Margin="0,0,0,12">
                            
                            <!-- Day Badges Row -->
                            <Border Grid.Row="0" Grid.Column="0" StrokeShape="RoundRectangle 8" Padding="4">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                        <GradientStop Color="#3B82F6" Offset="0.0" />
                                        <GradientStop Color="#2563EB" Offset="1.0" />
                                    </LinearGradientBrush>
                                </Border.Background>
                                <Label Text="SEG" FontSize="10" FontAttributes="Bold" TextColor="White" HorizontalTextAlignment="Center" VerticalTextAlignment="Center" />
                            </Border>
                            
                            <Border Grid.Row="0" Grid.Column="1" StrokeShape="RoundRectangle 8" Padding="4">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                        <GradientStop Color="#10B981" Offset="0.0" />
                                        <GradientStop Color="#059669" Offset="1.0" />
                                    </LinearGradientBrush>
                                </Border.Background>
                                <Label Text="TER" FontSize="10" FontAttributes="Bold" TextColor="White" HorizontalTextAlignment="Center" VerticalTextAlignment="Center" />
                            </Border>
                            
                            <Border Grid.Row="0" Grid.Column="2" StrokeShape="RoundRectangle 8" Padding="4">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                        <GradientStop Color="#A855F7" Offset="0.0" />
                                        <GradientStop Color="#9333EA" Offset="1.0" />
                                    </LinearGradientBrush>
                                </Border.Background>
                                <Label Text="QUA" FontSize="10" FontAttributes="Bold" TextColor="White" HorizontalTextAlignment="Center" VerticalTextAlignment="Center" />
                            </Border>
                            
                            <Border Grid.Row="0" Grid.Column="3" StrokeShape="RoundRectangle 8" Padding="4">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                        <GradientStop Color="#F97316" Offset="0.0" />
                                        <GradientStop Color="#EA580C" Offset="1.0" />
                                    </LinearGradientBrush>
                                </Border.Background>
                                <Label Text="QUI" FontSize="10" FontAttributes="Bold" TextColor="White" HorizontalTextAlignment="Center" VerticalTextAlignment="Center" />
                            </Border>
                            
                            <Border Grid.Row="0" Grid.Column="4" StrokeShape="RoundRectangle 8" Padding="4">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                        <GradientStop Color="#EF4444" Offset="0.0" />
                                        <GradientStop Color="#DC2626" Offset="1.0" />
                                    </LinearGradientBrush>
                                </Border.Background>
                                <Label Text="SEX" FontSize="10" FontAttributes="Bold" TextColor="White" HorizontalTextAlignment="Center" VerticalTextAlignment="Center" />
                            </Border>
                            
                            <Border Grid.Row="0" Grid.Column="5" StrokeShape="RoundRectangle 8" Padding="4">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                        <GradientStop Color="#6366F1" Offset="0.0" />
                                        <GradientStop Color="#4F46E5" Offset="1.0" />
                                    </LinearGradientBrush>
                                </Border.Background>
                                <Label Text="SÁB" FontSize="10" FontAttributes="Bold" TextColor="White" HorizontalTextAlignment="Center" VerticalTextAlignment="Center" />
                            </Border>
                            
                            <Border Grid.Row="0" Grid.Column="6" StrokeShape="RoundRectangle 8" Padding="4">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                        <GradientStop Color="#64748B" Offset="0.0" />
                                        <GradientStop Color="#475569" Offset="1.0" />
                                    </LinearGradientBrush>
                                </Border.Background>
                                <Label Text="DOM" FontSize="10" FontAttributes="Bold" TextColor="White" HorizontalTextAlignment="Center" VerticalTextAlignment="Center" />
                            </Border>
                            
                            <!-- Titles Row -->
                            <Label Grid.Row="1" Grid.Column="0" Text="TREINO 1" FontSize="9" FontAttributes="Bold" TextColor="#334155" HorizontalTextAlignment="Center" LineBreakMode="WordWrap" />
                            <Label Grid.Row="1" Grid.Column="1" Text="TREINO 2" FontSize="9" FontAttributes="Bold" TextColor="#334155" HorizontalTextAlignment="Center" LineBreakMode="WordWrap" />
                            <Label Grid.Row="1" Grid.Column="2" Text="TREINO 3" FontSize="9" FontAttributes="Bold" TextColor="#334155" HorizontalTextAlignment="Center" LineBreakMode="WordWrap" />
                            <Label Grid.Row="1" Grid.Column="3" Text="TREINO 4" FontSize="9" FontAttributes="Bold" TextColor="#334155" HorizontalTextAlignment="Center" LineBreakMode="WordWrap" />
                            <Label Grid.Row="1" Grid.Column="4" Text="TREINO 5" FontSize="9" FontAttributes="Bold" TextColor="#334155" HorizontalTextAlignment="Center" LineBreakMode="WordWrap" />
                            <Label Grid.Row="1" Grid.Column="5" Text="TREINO 6" FontSize="9" FontAttributes="Bold" TextColor="#334155" HorizontalTextAlignment="Center" LineBreakMode="WordWrap" />
                            <Label Grid.Row="1" Grid.Column="6" Text="DESNCASO" FontSize="9" FontAttributes="Bold" TextColor="#334155" HorizontalTextAlignment="Center" LineBreakMode="WordWrap" />
                        </Grid>
                        
                        <!-- Small legend -->
                        <BoxView HeightRequest="1" BackgroundColor="#E2E8F0" Margin="0,8" />
                        <Label Text="Toque para expandir/ocultar os exercícios de cada dia" FontSize="11" TextColor="#64748B" HorizontalTextAlignment="Center" />
                    </VerticalStackLayout>
                </Border>

                <!-- Workout Days Collection -->
                <CollectionView ItemsSource="{Binding Workouts}"
                                SelectionMode="None">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="model:HomeWorkout">
                            <Border Margin="0,0,0,12"
                                    BackgroundColor="#FFFFFFF2"
                                    StrokeThickness="0"
                                    StrokeShape="RoundRectangle 20"
                                    Padding="0">
                                <Border.Shadow>
                                    <Shadow Brush="#0000001F" Offset="0,4" Radius="12" />
                                </Border.Shadow>
                                
                                <VerticalStackLayout Spacing="0">
                                    <!-- Day Header (Clickable) -->
                                    <Border BackgroundColor="Transparent"
                                            StrokeThickness="0"
                                            Padding="16">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding BindingContext.ToggleDayCommand, Source={x:Reference HomeWorkoutRoot}}"
                                                                  CommandParameter="{Binding .}" />
                                        </Border.GestureRecognizers>
                                        
                                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                            <!-- Color Indicator -->
                                            <BoxView Grid.Column="0"
                                                     WidthRequest="12"
                                                     HeightRequest="12"
                                                     CornerRadius="6"
                                                     VerticalOptions="Center">
                                                <BoxView.Background>
                                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                        <GradientStop Color="{Binding GradientStart}" Offset="0.0" />
                                                        <GradientStop Color="{Binding GradientEnd}" Offset="1.0" />
                                                    </LinearGradientBrush>
                                                </BoxView.Background>
                                            </BoxView>
                                            
                                            <!-- Day and Title -->
                                            <VerticalStackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                                                <Label Text="{Binding Day}"
                                                       FontSize="16"
                                                       FontAttributes="Bold"
                                                       TextColor="#1E293B" />
                                                <Label Text="{Binding Title}"
                                                       FontSize="14"
                                                       TextColor="#64748B" />
                                            </VerticalStackLayout>
                                            
                                            <!-- Arrow Icon -->
                                            <Label Grid.Column="2"
                                                   FontSize="20"
                                                   TextColor="#64748B"
                                                   VerticalTextAlignment="Center">
                                                <Label.Triggers>
                                                    <DataTrigger TargetType="Label" Binding="{Binding IsExpanded}" Value="True">
                                                        <Setter Property="Text" Value="▲" />
                                                    </DataTrigger>
                                                    <DataTrigger TargetType="Label" Binding="{Binding IsExpanded}" Value="False">
                                                        <Setter Property="Text" Value="▼" />
                                                    </DataTrigger>
                                                </Label.Triggers>
                                            </Label>
                                        </Grid>
                                    </Border>
                                    
                                    <!-- Details (Expandable) -->
                                    <VerticalStackLayout IsVisible="{Binding IsExpanded}"
                                                         Padding="16,0,16,16"
                                                         Spacing="12">
                                        <BoxView HeightRequest="1" 
                                                 BackgroundColor="#E2E8F0" 
                                                 Margin="0,0,0,12" />

                                        <!-- Table layout (when IsTable) -->
                                        <VerticalStackLayout IsVisible="{Binding IsTable}" Spacing="10">
                                            <!-- Header -->
                                            <Grid BackgroundColor="#F5F5F5" Padding="10">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="80" />
                                                    <ColumnDefinition Width="110" />
                                                    <ColumnDefinition Width="90" />
                                                </Grid.ColumnDefinitions>
                                                <Label Grid.Column="0" Text="Exercício" FontAttributes="Bold" TextColor="#334155" />
                                                <Label Grid.Column="1" Text="Avançado" FontAttributes="Bold" HorizontalTextAlignment="Center" TextColor="#334155" />
                                                <Label Grid.Column="2" Text="Intermediário" FontAttributes="Bold" HorizontalTextAlignment="Center" TextColor="#334155" />
                                                <Label Grid.Column="3" Text="Iniciante" FontAttributes="Bold" HorizontalTextAlignment="Center" TextColor="#334155" />
                                            </Grid>
                                            <!-- Rows -->
                                            <CollectionView ItemsSource="{Binding TableData.Rows}" SelectionMode="None">
                                                <CollectionView.ItemTemplate>
                                                    <DataTemplate x:DataType="model:TableRow">
                                                        <Grid Padding="10,6" BackgroundColor="#FFFFFF">
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="*" />
                                                                <ColumnDefinition Width="80" />
                                                                <ColumnDefinition Width="110" />
                                                                <ColumnDefinition Width="90" />
                                                            </Grid.ColumnDefinitions>
                                                            <Label Grid.Column="0" Text="{Binding Exercise}" VerticalOptions="Center" TextColor="#334155" />
                                                            <Label Grid.Column="1" Text="{Binding Advanced}" HorizontalTextAlignment="Center" VerticalOptions="Center" FontAttributes="Bold" TextColor="#334155" />
                                                            <Label Grid.Column="2" Text="{Binding Intermediate}" HorizontalTextAlignment="Center" VerticalOptions="Center" FontAttributes="Bold" TextColor="#334155" />
                                                            <Label Grid.Column="3" Text="{Binding Beginner}" HorizontalTextAlignment="Center" VerticalOptions="Center" FontAttributes="Bold" TextColor="#334155" />
                                                        </Grid>
                                                    </DataTemplate>
                                                </CollectionView.ItemTemplate>
                                            </CollectionView>
                                            <Frame BackgroundColor="#FFF3CD" BorderColor="#FFEAA7" Padding="12">
                                                <Label Text="Nota: Exercícios com * devem ser contados de um lado só. Caso conte para os dois lados, o número total será dobrado."
                                                       FontSize="13"
                                                       TextColor="#856404" />
                                            </Frame>
                                        </VerticalStackLayout>

                                        <!-- Sections (when not table) -->
                                        <VerticalStackLayout IsVisible="{Binding IsTable, Converter={StaticResource InverseBoolConverter}}"
                                                             Spacing="12">
                                            <VerticalStackLayout BindableLayout.ItemsSource="{Binding Sections}" Spacing="12">
                                                <BindableLayout.ItemTemplate>
                                                    <DataTemplate x:DataType="model:WorkoutSection">
                                                        <VerticalStackLayout Spacing="10">
                                                            <Label Text="{Binding Title}"
                                                                   FontSize="16"
                                                                   FontAttributes="Bold"
                                                                   TextColor="#1E293B" />
                                                            <VerticalStackLayout BindableLayout.ItemsSource="{Binding Exercises}" Spacing="8">
                                                                <BindableLayout.ItemTemplate>
                                                                    <DataTemplate x:DataType="model:Exercise">
                                                                        <Border BackgroundColor="#F8FAFC"
                                                                                StrokeThickness="0"
                                                                                StrokeShape="RoundRectangle 12"
                                                                                Padding="12">
                                                                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                                                                <VerticalStackLayout Grid.Column="0" Spacing="4">
                                                                                    <Label Text="{Binding Name}"
                                                                                           FontSize="14"
                                                                                           FontAttributes="Bold"
                                                                                           TextColor="#1E293B"
                                                                                           LineBreakMode="WordWrap" />
                                                                                    <Label Text="{Binding Details}"
                                                                                           FontSize="13"
                                                                                           TextColor="#64748B"
                                                                                           IsVisible="{Binding Details, Converter={StaticResource StringToBoolConverter}}" />
                                                                                </VerticalStackLayout>
                                                                                
                                                                                <!-- Video Button -->
                                                                                <Border Grid.Column="1"
                                                                                        BackgroundColor="#EF4444"
                                                                                        StrokeThickness="0"
                                                                                        StrokeShape="RoundRectangle 20"
                                                                                        Padding="8"
                                                                                        HeightRequest="40"
                                                                                        WidthRequest="40"
                                                                                        VerticalOptions="Center">
                                                                                    <Border.Shadow>
                                                                                        <Shadow Brush="#EF4444" Offset="0,2" Radius="8" Opacity="0.4" />
                                                                                    </Border.Shadow>
                                                                                    <Border.GestureRecognizers>
                                                                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:HomeWorkoutViewModel}}, Path=OpenVideoCommand}"
                                                                                                              CommandParameter="{Binding .}" />
                                                                                    </Border.GestureRecognizers>
                                                                                    <Label Text="▶"
                                                                                           FontSize="16"
                                                                                           TextColor="White"
                                                                                           HorizontalTextAlignment="Center"
                                                                                           VerticalTextAlignment="Center"
                                                                                           FontAttributes="Bold" />
                                                                                </Border>
                                                                            </Grid>
                                                                        </Border>
                                                                    </DataTemplate>
                                                                </BindableLayout.ItemTemplate>
                                                            </VerticalStackLayout>
                                                        </VerticalStackLayout>
                                                    </DataTemplate>
                                                </BindableLayout.ItemTemplate>
                                            </VerticalStackLayout>
                                        </VerticalStackLayout>
                                    </VerticalStackLayout>
                                </VerticalStackLayout>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Notes Card -->
                <Border BackgroundColor="#FFFFFFF2"
                        StrokeShape="RoundRectangle 20"
                        Padding="16"
                        Margin="0,4,0,24">
                    <Border.Shadow>
                        <Shadow Brush="#0000001F" Offset="0,4" Radius="8" />
                    </Border.Shadow>
                    
                    <VerticalStackLayout Spacing="8">
                        <Label Text="Observações Importantes"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="#1E293B" />
                        
                        <Label TextColor="#334155" FontSize="13" LineBreakMode="WordWrap">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="• Foque na técnica perfeita e controle de movimento" TextColor="Black"/>
                                    <Span Text="&#x0a;" />
                                    <Span Text="• Ajuste as repetições conforme seu nível" TextColor="Black"/>
                                    <Span Text="&#x0a;" />
                                    <Span Text="• Faça alongamentos leves após o treino" TextColor="Black"/>
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                    </VerticalStackLayout>
                </Border>
            </VerticalStackLayout>
        </ScrollView>
    </Grid>
</ContentPage>
